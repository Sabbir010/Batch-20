<?php
// --- ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Æ‡¶ø‡¶â‡¶ú‡¶ø‡¶ï ‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ (YouTube + MP3) ---

// $who ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤‡¶ü‡¶ø ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶°‡¶ø‡¶´‡¶æ‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§
// ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá music_link ‡¶è‡¶¨‡¶Ç music_expiry ‡¶Ü‡¶®‡¶¨‡ßã‡•§
$music_query = mysql_query("SELECT music_link, music_expiry FROM ibwfrr_users WHERE id='".$who."'");
$music_info = mysql_fetch_array($music_query);

$music_link = $music_info['music_link'];
$music_expiry = $music_info['music_expiry'];
$play_music = false;
$is_youtube = false;
$video_id = "";
$mp3_link = "";

// ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶Æ‡¶ø‡¶â‡¶ú‡¶ø‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
if (!empty($music_link) && $music_expiry > time()) {
  $play_music = true;
 
  // ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶è‡¶ü‡¶ø ‡¶á‡¶â‡¶ü‡¶ø‡¶â‡¶¨ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶ø‡¶®‡¶æ (‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: "youtube:VIDEO_ID")
  if (strpos($music_link, 'youtube:') === 0) {
    $is_youtube = true;
    $video_id = substr($music_link, 8); // "youtube:" ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ
  } else {
    // ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ MP3 ‡¶≤‡¶ø‡¶Ç‡¶ï
    $is_youtube = false;
    $mp3_link = htmlspecialchars($music_link);
  }
}
?>

<?php if ($play_music): // ‡¶Ø‡¶¶‡¶ø ‡¶Æ‡¶ø‡¶â‡¶ú‡¶ø‡¶ï ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ ‡¶•‡¶æ‡¶ï‡ßá ?>
 
  <?php if ($is_youtube): // --- ‡¶Ø‡¶¶‡¶ø ‡¶á‡¶â‡¶ü‡¶ø‡¶â‡¶¨ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶π‡¶Ø‡¶º --- ?>
   
        <div id="youtube-audio-player" style="width: 1px; height: 1px; overflow: hidden; position: absolute; left: -9999px;"></div>

        <script>
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var player;
      var videoId = '<?php echo $video_id; ?>';
      var playerReady = false;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-audio-player', {
          height: '1',
          width: '1',
          videoId: videoId,
          playerVars: {
            'autoplay': 1, // ‡¶Ö‡¶ü‡ßã‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ
            'controls': 0, // ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶∏ ‡¶π‡¶æ‡¶á‡¶°
            'loop': 1,   // ‡¶≤‡ßÅ‡¶™
            'playlist': videoId // ‡¶≤‡ßÅ‡¶™ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶Ü‡¶á‡¶°‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶Ø‡¶º
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      function onPlayerReady(event) {
        playerReady = true;
        // ‡¶Ö‡¶ü‡ßã‡¶™‡ßç‡¶≤‡ßá ‡¶™‡¶≤‡¶ø‡¶∏‡¶ø‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá .playVideo() ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶
        event.target.playVideo();
        event.target.setVolume(80); // ‡¶≠‡¶≤‡¶ø‡¶â‡¶Æ ‡ßÆ‡ß¶%
      }
     
      function onPlayerStateChange(event) {
        // ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ (‡¶≤‡ßÅ‡¶™)
        if (event.data == YT.PlayerState.ENDED) {
          player.playVideo();
        }
      }
     
      // ‡¶Ö‡¶ü‡ßã‡¶™‡ßç‡¶≤‡ßá ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ö‡¶ü‡ßã‡¶™‡ßç‡¶≤‡ßá ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá, ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá‡¶á ‡¶™‡ßç‡¶≤‡ßá ‡¶π‡¶¨‡ßá
      function attemptAutoplayFix() {
        if (playerReady && player.getPlayerState() !== YT.PlayerState.PLAYING) {
          player.playVideo();
        }
      }
     
      // ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞‡¶á ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
      document.body.addEventListener('click', attemptAutoplayFix, { once: true });
      document.body.addEventListener('touchstart', attemptAutoplayFix, { once: true });
     
    </script>

  <?php else: // --- ‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ MP3 ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶π‡¶Ø‡¶º --- ?>
   
    <div id='music_box' style='text-align:center; margin: 5px auto; padding: 5px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;'>
      <audio id='profAudio' loop preload='auto' autoplay style='position:absolute; left:-9999px;'>
        <source src="<?php echo $mp3_link; ?>" type="audio/mpeg">
      </audio>
      <small id='statusMsg' style='color:#666;'>üéµ Loading Music...</small><br/>
      <button id='playBtn' onclick='startMusic()' style='display:none; background: linear-gradient(to right, #ff416c, #ff4b2b); color:white; border:none; padding:5px 15px; border-radius:20px; cursor:pointer; font-size:12px; margin-top:5px;'>‚ñ∂ Play Music</button>
     
      <script>
        var audio = document.getElementById('profAudio');
        var btn = document.getElementById('playBtn');
        var msg = document.getElementById('statusMsg');
        var currentUrl = '<?php echo $mp3_link; ?>';

        try {
          var savedUrl = localStorage.getItem('last_music_url');
          var savedTime = localStorage.getItem('last_music_time');
          if (savedUrl === currentUrl && savedTime > 0) {
            audio.currentTime = savedTime;
          }
        } catch(e) {}

        audio.addEventListener('timeupdate', function() {
          try {
            localStorage.setItem('last_music_url', currentUrl);
            localStorage.setItem('last_music_time', audio.currentTime);
          } catch(e) {}
          if(!audio.paused) {
            msg.innerHTML = 'üéµ Playing...';
            btn.style.display = 'none';
          }
        });

        function startMusic() {
          audio.play();
          btn.style.display = 'none';
          msg.innerHTML = 'üéµ Playing...';
        }

        window.addEventListener('load', function() {
          var promise = audio.play();
          if (promise !== undefined) {
            promise.catch(error => {
              btn.style.display = 'inline-block';
              msg.innerHTML = 'Click play button ‚§µ';
            });
          }
        });
       
        document.body.addEventListener('click', function() {
          if(audio.paused) {
            audio.play();
          }
        }, { once: true });
      </script>
    </div>
   
  <?php endif; ?>
<?php endif; ?>

<?php
// --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∂‡ßá‡¶∑ ---